# -*- mode: ruby -*-
# vi: set ft=ruby :

disk_size = 5 * 1024

file_root = File.dirname(File.expand_path(__FILE__))

$nvme_disks = {
    File.join(file_root, "nvme0.vdi") => "0",
    File.join(file_root, "nvme1.vdi") => "1"
}

$disk_size = disk_size.to_s

class VagrantPlugins::ProviderVirtualBox::Action::SetName
    alias_method :original_call, :call
    def call(env)
        ui = env[:ui]
        controller_name = "NVMe"
        driver = env[:machine].provider.driver
        uuid = driver.instance_eval { @uuid }
        vm_info = driver.execute("showvminfo", uuid)
        has_controller = vm_info.match("Storage Controller Name.*#{controller_name}")

        if !has_controller
            ui.info "Creating storage controller '#{controller_name}'..."
            driver.execute(
                "storagectl", uuid,
                "--name", "#{controller_name}",
                "--add", "pcie",
                "--controller", "NVMe",
                "--portcount", "2",
                "--hostiocache", "off"
            )
        end

        $nvme_disks.each do |disk_file, port|
            if !File.exist?(disk_file)
                ui.info "Creating storage file '#{disk_file}'..."
                driver.execute(
                  "createmedium", "disk",
                  "--filename", disk_file,
                  "--format", "VDI",
                  "--size", $disk_size,
                  "--variant", "Fixed"
                )
            end

            ui.info "Attaching '#{disk_file}' to '#{controller_name}'..."
            driver.execute(
                "storageattach", uuid,
                "--storagectl", "#{controller_name}",
                "--port", port,
                "--device", "0",
                "--type", "hdd",
                '--nonrotational', 'on',
                "--medium", disk_file,
                "--mtype", "shareable"
            )
        end
        original_call(env)
    end
end

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure("2") do |config|

  config.vm.box = "ubuntu/xenial64"
  config.vm.box_check_update = false

  config.vm.provider "virtualbox" do |vb|
    # Display the VirtualBox GUI when booting the machine
    vb.gui = false
    vb.memory = "1024"
  end

  config.vm.define "iscsi-target0" do |target0|
    target0.vm.network "private_network", ip: "10.0.1.100"
    target0.vm.provider "virtualbox" do |vb|
      vb.name = "iscsi-target0"
    end

    target0.vm.provision "shell", inline: <<-SHELL
      locale-gen

      #enable clvm locking
      sudo sed -i -e 's/locking_type = 1/locking_type = 3/' /etc/lvm/lvm.conf
      #disable lvmetad as it is not compatible with clvm
      sudo sed -i -e 's/use_lvmetad = 1/use_lvmetad = 0/' /etc/lvm/lvm.conf
      sudo systemctl stop lvm2-lvmetad.socket
      sudo systemctl stop lvm2-lvmetad

      sudo apt-get update && apt-get install -y corosync

      #use private network for clustering
      sudo sed -i -e 's/bindnetaddr: 127.0.0.1/bindnetaddr: 10.0.1.100/' /etc/corosync/corosync.conf
      #reduce member count for quorum, as we don't have second node yet
      sudo sed -i -e 's/expected_votes: 2/expected_votes: 1/' /etc/corosync/corosync.conf
      sudo systemctl restart corosync

      sudo corosync-quorumtool -s

      sudo apt-get install -y dlm clvm

      sudo systemctl status dlm
      sleep 1
      sudo systemctl start dlm

      #some workarounds for clvm init script
      sudo mkdir -p /etc/cluster && sudo touch /etc/cluster/cluster.conf
      sudo sed -i -e 's/\\/usr\\/sbin\\/corosync-quorumtool -s/true/' /etc/init.d/clvm

      sudo systemctl daemon-reload
      sudo systemctl stop clvm
      sudo systemctl start clvm

      sudo systemctl status clvm

      #create clustered volume group
      sudo lvm vgcreate --clustered y nvmegroup /dev/nvme0n1 /dev/nvme0n2
      sudo lvm lvcreate nvmegroup -L 3G
      sudo lvm lvcreate nvmegroup -L 3G
      sudo lvm lvcreate nvmegroup -L 3G

      sudo apt-get install -y targetcli

      sudo targetcli /backstores/iblock create name=lvol0 dev=/dev/nvmegroup/lvol0
      sudo targetcli /backstores/iblock create name=lvol1 dev=/dev/nvmegroup/lvol1
      sudo targetcli /backstores/iblock create name=lvol2 dev=/dev/nvmegroup/lvol2

      sudo targetcli /iscsi create iqn.2003-01.org.linux-iscsi.ubuntu-xenial.x8664:sn.ba53b24fa0e2

      sudo targetcli /iscsi/iqn.2003-01.org.linux-iscsi.ubuntu-xenial.x8664:sn.ba53b24fa0e2/tpg1 set attribute authentication=0 demo_mode_write_protect=0 generate_node_acls=1 cache_dynamic_acls=1

      sudo targetcli /iscsi/iqn.2003-01.org.linux-iscsi.ubuntu-xenial.x8664:sn.ba53b24fa0e2/tpg1/portals create ip_address=10.0.1.100

      sudo targetcli /iscsi/iqn.2003-01.org.linux-iscsi.ubuntu-xenial.x8664:sn.ba53b24fa0e2/tpg1/luns create storage_object=/backstores/iblock/lvol0
      sudo targetcli /iscsi/iqn.2003-01.org.linux-iscsi.ubuntu-xenial.x8664:sn.ba53b24fa0e2/tpg1/luns create storage_object=/backstores/iblock/lvol1
      sudo targetcli /iscsi/iqn.2003-01.org.linux-iscsi.ubuntu-xenial.x8664:sn.ba53b24fa0e2/tpg1/luns create storage_object=/backstores/iblock/lvol2

      yes | sudo targetcli saveconfig

      cp /etc/target/scsi_target.lio /vagrant/
    SHELL

  end

  config.vm.define "iscsi-target1" do |target1|
    target1.vm.network "private_network", ip: "10.0.1.101"
    target1.vm.provider "virtualbox" do |vb|
      vb.name = "iscsi-target1"
    end
    target1.vm.provision "shell", inline: <<-SHELL
      locale-gen

      sudo sed -i -e 's/locking_type = 1/locking_type = 3/' /etc/lvm/lvm.conf
      sudo sed -i -e 's/use_lvmetad = 1/use_lvmetad = 0/' /etc/lvm/lvm.conf
      sudo systemctl stop lvm2-lvmetad.socket
      sudo systemctl stop lvm2-lvmetad

      sudo apt-get update && apt-get install -y corosync

      sudo sed -i -e 's/bindnetaddr: 127.0.0.1/bindnetaddr: 10.0.1.101/' /etc/corosync/corosync.conf
      sudo sed -i -e 's/expected_votes: 2/expected_votes: 1/' /etc/corosync/corosync.conf
      sudo systemctl restart corosync

      apt-get install -y dlm clvm

      sudo systemctl status dlm
      sleep 1
      sudo systemctl start dlm

      sudo mkdir -p /etc/cluster && sudo touch /etc/cluster/cluster.conf
      sudo sed -i -e 's/\\/usr\\/sbin\\/corosync-quorumtool -s/true/' /etc/init.d/clvm

      sudo systemctl daemon-reload
      sudo systemctl stop clvm
      sudo systemctl start clvm

      sudo lvm vgdisplay

      sudo apt-get install -y targetcli

      sudo cp /vagrant/scsi_target.lio /etc/target/
      rm /vagrant/scsi_target.lio
      sudo sed -i -e 's/10.0.1.100/10.0.1.101/' /etc/target/scsi_target.lio

      targetcli ls /
      sleep 5

      sudo python /vagrant/iscsi_import.py
      sudo targetcli ls /

    SHELL
  end
end
